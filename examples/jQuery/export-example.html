<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jQuery Calendar Export Example</title>
    <style>
      table {
        border-collapse: collapse;
      }
      th,
      td {
        padding: 0;
      }
    </style>
  </head>

  <body>
    <h1>jQuery Calendar Export Example</h1>
    <div style="margin-bottom: 10px">
      <button id="btn-export">Export to ICS</button>
    </div>
    <div id="calendar"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@verbpatch/jquery-calendar/dist/index.umd.js"></script>
    <script>
      $(document).ready(function () {
        $('#calendar').headlessCalendar({
          defaultView: 'month',
          startOfWeek: 1,
          locale: 'en-IN',
          initialEvents: [
            // 1. Single-day event
            {
              id: '1',
              title: 'Simple Meeting',
              start: new Date(new Date().setHours(9, 0, 0, 0)),
              end: new Date(new Date().setHours(10, 0, 0, 0)),
              color: '#3b82f6',
            },
            // 2. All-day event
            {
              id: '2',
              title: 'Company Holiday',
              start: new Date(),
              end: new Date(),
              allDay: true,
              color: '#ef4444',
            },
            // 3. Multi-day event
            {
              id: '3',
              title: 'Business Trip',
              start: new Date(new Date().setHours(9, 0, 0, 0)),
              end: new Date(
                new Date(new Date().getTime() + 2 * 24 * 60 * 60 * 1000).setHours(17, 0, 0, 0),
              ),
              color: '#10b981',
            },
            // 4. Daily Standup (Weekdays only)
            {
              id: '4',
              title: 'Daily Standup',
              start: new Date(new Date().setHours(10, 0, 0, 0)),
              end: new Date(new Date().setHours(10, 30, 0, 0)),
              color: '#f59e0b',
              recurring: {
                repeat: 'weekly',
                every: 1,
                weekDays: [1, 2, 3, 4, 5], // Mon-Fri
              },
            },
            // 5. Weekly recurring event
            {
              id: '5',
              title: 'Weekly Planning',
              start: new Date(new Date().setHours(14, 0, 0, 0)),
              end: new Date(new Date().setHours(15, 0, 0, 0)),
              color: '#8b5cf6',
              recurring: {
                repeat: 'weekly',
                every: 1,
                weekDays: [1], // Monday
                end: new Date(new Date().getFullYear(), 11, 31),
              },
            },
            // 6. Monthly by day
            {
              id: '6',
              title: 'Monthly Payday',
              start: new Date(new Date().setDate(25)),
              end: new Date(new Date().setDate(25)),
              allDay: true,
              color: '#ec4899',
              recurring: {
                repeat: 'monthly',
                every: 1,
                day: 25,
              },
            },
            // 7. Monthly by week position (2nd Friday)
            {
              id: '7',
              title: 'Team Lunch',
              start: new Date(new Date().setHours(12, 0, 0, 0)),
              end: new Date(new Date().setHours(13, 0, 0, 0)),
              color: '#6366f1',
              recurring: {
                repeat: 'monthly',
                every: 1,
                week: 2,
                weekDays: [5], // Friday
              },
            },
            // 8. Yearly recurring
            {
              id: '8',
              title: 'New Year Party',
              start: new Date(new Date().getFullYear(), 0, 1),
              end: new Date(new Date().getFullYear(), 0, 1),
              allDay: true,
              color: '#f43f5e',
              recurring: {
                repeat: 'yearly',
                every: 1,
                month: 0, // Jan
                day: 1,
              },
            },
            // 9. Rich metadata
            {
              id: '9',
              title: 'Client Demo',
              start: new Date(new Date().setHours(15, 0, 0, 0)),
              end: new Date(new Date().setHours(16, 0, 0, 0)),
              description: 'Demo of the new product features.\nSee attachment for details.',
              location: 'Conference Room A',
              url: 'https://example.com/meeting',
              color: '#06b6d4',
            },
            // 10. Timezone specific
            {
              id: '10',
              title: 'Global Sync',
              start: new Date(new Date().setHours(20, 0, 0, 0)),
              end: new Date(new Date().setHours(21, 0, 0, 0)),
              description: 'Late night sync for global teams',
              color: '#64748b',
              timezone: 'America/New_York',
            },
          ],
          onRender: function (cal) {
            const { view, monthData, weekData, dayData, timeSlots, utils, visibleEvents } = cal;

            let html = `
            <table border="0" width="840" cellspacing="0" style="height:700px; border-left:1px solid; border-top:1px solid;">
              <thead>
                <tr>
                  <th colspan="2" style="border-bottom: 1px solid;">
                    <button type="button" id="btn-prev"> ← </button>
                    <button type="button" id="btn-today"> Today </button>
                    <button type="button" id="btn-next"> → </button>
                  </th>
                  <th colspan="3" style="border-bottom: 1px solid;">
                    <h3>
                      ${view === 'month' ? monthData?.monthName || '' : ''}
                      ${view === 'week' ? weekData?.weekRange || '' : ''}
                      ${view === 'day' ? dayData?.dayName || '' : ''}
                    </h3>
                  </th>
                  <th colspan="2" style="border-bottom: 1px solid; border-right:1px solid;">
                    <select id="view-select">
                      <option value="month" ${view === 'month' ? 'selected' : ''}>Month</option>
                      <option value="week" ${view === 'week' ? 'selected' : ''}>Week</option>
                      <option value="day" ${view === 'day' ? 'selected' : ''}>Day</option>
                    </select>
                  </th>
                </tr>
              </thead>
              <tbody>
          `;

            if (view === 'month' && monthData) {
              html += '<tr>';
              utils.daysofWeek('short').forEach((day) => {
                html += `<th style="width: 120px; border-right:1px solid; border-bottom:1px solid;">${day}</th>`;
              });
              html += '</tr>';

              monthData.weeks.forEach((week) => {
                html += '<tr>';
                week.forEach((date) => {
                  const isCurrentMonth = monthData.isCurrentMonth(date);
                  const isToday = monthData.isToday(date);
                  const events = cal.getEventsForDate(date);
                  //console.log({ date, events });
                  html += `
                  <td style="
                    ${!isCurrentMonth ? 'color: gray;' : ''}
                    ${isToday ? 'font-weight: bold;' : ''}
                    border-right: 1px solid; border-bottom: 1px solid; vertical-align: top; height: 100px;
                  ">
                    <div>${utils.formatDate(date, 'd')}</div>
                    ${events
                      .map(
                        (e) =>
                          `<div style="font-size: 10px; background: ${e.color || '#ccc'}; color: white; margin: 2px 0; padding: 2px;">${e.title}</div>`,
                      )
                      .join('')}
                  </td>
                `;
                });
                html += '</tr>';
              });
            } else if (view === 'week' && weekData) {
              html += `
                          <tr>
                            <td colspan="7" style="border-right:1px solid;">
                              <table cellpadding="5" cellspacing="0" width="100%">
                                <tbody>
                                  <tr>
                                    <td></td>
                                    ${weekData.dates
                                      .map(
                                        (date) => `
                                      <td style="${weekData.isToday(date) ? 'font-weight: bold;' : ''}">
                                        ${utils.formatDateTime(date, 'EEE d')}
                                      </td>
                                    `,
                                      )
                                      .join('')}
                                  </tr>
                                  <!-- All Day Row -->
                                  <tr>
                                    <td style="border-bottom: 1px solid; font-size: 11px;">All Day</td>
                                    ${weekData.dates
                                      .map((date) => {
                                        const allDayEvents = cal
                                          .getEventsForDate(date)
                                          .filter((e) => e.allDay);
                                        return `
                                        <td style="border-bottom: 1px solid; border-left: 1px solid; vertical-align: top; background: #fafafa;">
                                          ${allDayEvents.map((e) => `<div style="font-size: 10px; background: ${e.color || '#ccc'}; color: white; margin: 1px 0; padding: 2px; border-radius: 2px;">${e.title}</div>`).join('')}
                                        </td>
                                        `;
                                      })
                                      .join('')}
                                  </tr>
                                  ${timeSlots
                                    .map(
                                      (slot) => `
                                    <tr>
                                      <td style="border-bottom: 1px solid;">${slot.label}</td>
                                      ${weekData.dates
                                        .map((date) => {
                                          // Filter events for this specific time slot
                                          const slotEvents = cal
                                            .getEventsForDate(date)
                                            .filter((event) => {
                                              if (event.allDay) return false; // Skip all-day events in time slots

                                              // Construct slot date/time
                                              const slotTime = new Date(date);
                                              slotTime.setHours(slot.hour, slot.minute, 0, 0);

                                              const eventStart = new Date(event.start);
                                              const eventEnd = new Date(event.end);

                                              // Check if slot time falls within event range
                                              return utils.dateTimeInBetween(
                                                slotTime,
                                                eventStart,
                                                eventEnd,
                                              );
                                            });

                                          return `
                                        <td style="${weekData.isToday(date) ? 'font-weight: bold;' : ''} border-bottom: 1px solid; border-left: 1px solid; vertical-align: top;">
                                          ${slotEvents
                                            .map(
                                              (e) =>
                                                `<div style="font-size: 10px; background: ${e.color || '#ccc'}; color: white; margin: 1px 0; padding: 2px;">${e.title}</div>`,
                                            )
                                            .join('')}
                                        </td>
                                      `;
                                        })
                                        .join('')}
                                    </tr>
                                  `,
                                    )
                                    .join('')}
                                </tbody>
                              </table>
                            </td>
                          </tr>
                        `;
            } else if (view === 'day' && dayData) {
              const date = dayData.dates[0];
              const allDayEvents = cal.getEventsForDate(date).filter((e) => e.allDay);

              html += `
              <tr>
                <td colspan="7" align="center" style="border-right: 1px solid; border-bottom: 1px solid;">
                  ${dayData.dayName}
                </td>
              </tr>
              <tr>
                <td colspan="7" style="border-right: 1px solid;">
                  <table width="100%" cellspacing="0" style="height: 100%;">
                    <tbody>
                      <!-- All Day Row -->
                      ${
                        allDayEvents.length > 0
                          ? `
                      <tr>
                        <td width="25%" style="border-bottom: 1px solid; font-size: 11px; padding: 5px;">All Day</td>
                        <td style="border-bottom: 1px solid; background: #fafafa; padding: 5px;">
                           ${allDayEvents.map((e) => `<div style="font-size: 10px; background: ${e.color || '#ccc'}; color: white; margin: 2px 0; padding: 2px; border-radius: 2px;">${e.title}</div>`).join('')}
                        </td>
                      </tr>
                      `
                          : ''
                      }
                      ${timeSlots
                        .map((slot) => {
                          const slotEvents = cal.getEventsForDate(date).filter((event) => {
                            if (event.allDay) return false;

                            const slotTime = new Date(date);
                            slotTime.setHours(slot.hour, slot.minute, 0, 0);
                            const eventStart = new Date(event.start);
                            const eventEnd = new Date(event.end);
                            // Inclusive start, exclusive end
                            return slotTime >= eventStart && slotTime < eventEnd;
                          });

                          return `                        <tr>
                          <td width="25%" style="border-bottom: 1px solid; vertical-align: top;">
                            ${slot.label} 
                          </td>
                          <td style="border-bottom: 1px solid;">
                             ${slotEvents
                               .map(
                                 (e) =>
                                   `<div style="font-size: 10px; background: ${e.color || '#ccc'}; color: white; margin: 1px 0; padding: 2px;">${e.title}</div>`,
                               )
                               .join('')}
                          </td>
                        </tr>
                      `;
                        })
                        .join('')}
                    </tbody>
                  </table>
                </td>
              </tr>
            `;
            }

            html += '</tbody></table>';
            $('#calendar').html(html);
          },
        });

        $(document).on('click', '#btn-prev', function () {
          $('#calendar').headlessCalendar('goToPrevious');
        });

        $(document).on('click', '#btn-today', function () {
          $('#calendar').headlessCalendar('goToToday');
        });

        $(document).on('click', '#btn-next', function () {
          $('#calendar').headlessCalendar('goToNext');
        });

        $(document).on('change', '#view-select', function () {
          $('#calendar').headlessCalendar('changeView', this.value);
        });

        $('#btn-export').click(function () {
          const calendarInstance = $('#calendar').headlessCalendar('getCalendar');
          calendarInstance.downloadICS('my-calendar-events.ics');
        });
      });
    </script>
  </body>
</html>
